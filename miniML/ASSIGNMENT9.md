# Assignment 9 (140 points)

The goal of this assignment is to test your type inference and type checker
implementations from previous assignments using QuickCheck property-based
testing.

## Deliverables

Submit the files `Main.hs` and `Gen.hs` from the `test/` directory to the Helios
submission page. Do not submit zip files. Your files should compile with the
rest of the Cabal project without any modifications to the existing code.

## Test Case Generators (70 points)

Write a random program generator for MiniML programs using QuickCheck's
generators. Review the testing case study on well-typed programs in the 
[lecture notes](https://github.com/zoep/PL2/blob/d8d8acc89fc40cca4c458562c5c7bbc06e1659ef/lectures/Haskell/src/QuickCheck.hs#L657)
and consult QuickCheck's
[documentation](https://hackage-content.haskell.org/package/QuickCheck-2.17.1.0/docs/Test-QuickCheck.html)
as needed.

Take note of the following:

- **Non-terminating terms**: Your generator should avoid generating programs
  that do not terminate. The simplest approach is to avoid generating truly
  recursive functions.
- **Soundness**: Your generator should only generate terms of a valid type.
- **Completeness**: Your generator should be as complete as possible, covering
   as many well-typed terms of the language as possible.
- **Polymorphism**: You do not need to generate terms of polymorphic types.
- **Type annotations**: Your generator should be able to generate both
  fully annotated terms (to test type checking) and terms without type
  annotations (to test type inference). In the latter case, be careful as a
  typed term generated by the generator may have a more general type. For
  example, your generator may generate `fun x -> x` as a term of type `int ->
  int`, but type inference will infer the most general type for this term,
  which is `forall a. a -> a`.

## Testing MiniML (60 points)

- **Warm up (5 points)**: Write a QuickCheck property for the type checker. It
  should assert that for any generated term of type `t`, the type checker should
  assign it the same type.
- **Type inference (20 points)**: Write a QuickCheck property for the type
  inference program. State carefully what property should hold for the type inference
  implementation.
- **Closure conversion (35 points)**: Write a QuickCheck property testing the
  correctness of closure conversion. Use the provided evaluators `evalTop` (for
  higher-order programs) and `evalTopCC` (for closure-converted programs) to
  verify semantic preservation. When comparing results, only ground (i.e., not
  functions) terms can be compared for equality. You can assert that any closure
  in the source evaluation corresponds to an closure in the target evaluation
  (be mindful of how closures are represented in the target), but you can ignore
  the contents of the closures (code and environment). Be extra careful when you
  are comparing memory locations. Make sure to answer Question 1 in the file
  `test/Main.hs`.


## Discovering Bugs (10 points)

- **Find the bug (10 points)** There is a hidden bug in the implementation of
  one of the provided helper functions in `Syntax.hs` that are used in closure
  conversion. Use the random property tester you wrote above to find and correct
  the bug. Describe the bug and its solution in the answer of Question 2 in the
  file `test/Main.hs`.


- If you discover bugs in your implementation of type inference and closure
  conversion during testing and fix them, you will have the opportunity to
  resubmit assignments 6 and 8 during a short submission window, provided you
  submit a README explaining the bugs found and their solutions. More specific
  instructions will be announced.  


## How to Run the Test Suite

To run the test suite, use:

```
cabal test
```

You can also enter a REPL for the test suite with:

```
cabal repl test
```

Then you can run commands like:

```
ghci> import Test.QuickCheck
ghci> quickCheck typeCheckProp
+++ OK, passed 100 tests.
```